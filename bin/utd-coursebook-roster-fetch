#!/usr/bin/env python

if __name__ == '__main__':

    from selenium import webdriver
    from datetime import datetime
    import time
    import tempfile
    import shutil
    import argparse
    import glob
    import sys
    import os
    import getpass

    parser = argparse.ArgumentParser(
                    description='CourseBook Roster Fetch',
                    formatter_class=argparse.ArgumentDefaultsHelpFormatter,
                )
    parser.add_argument(
            '--username', 
            type=str, 
            required=True,
        )
    parser.add_argument(
            '--courses', 
            type=str, 
            required=True,
            nargs='+',
        )
    parser.add_argument(
            '--destdir', 
            required=True, 
            type=str,
        )

    args = parser.parse_args()

    print "username: '{}'".format(args.username)
    print "courses : '{}'".format(args.courses)
    print "destdir : '{}'".format(args.destdir)

    password = getpass.getpass()

    def download():
        options = webdriver.ChromeOptions()
        options.add_argument('disable-java')
        options.add_experimental_option('prefs', {'download.default_directory': args.destdir}) 
        driver = webdriver.Chrome(chrome_options=options)

        driver.implicitly_wait(30)

        url_head = "https://coursebook.utdallas.edu"

        #
        # Log in.
        #
        driver.get(url_head + '/login/coursebook')

        username_element = driver.find_element_by_id("netid")
        password_element = driver.find_element_by_id("password")
        login_button     = driver.find_element_by_id("login-button")
        
        username_element.clear()
        password_element.clear()

        username_element.send_keys(args.username)
        password_element.send_keys(password)
        login_button.click()

        #
        # Perform the searches.
        #
        for course in args.courses:
            # course = 'math1314.001.15f
            url_tail = '/reportmonkey/class_roster/' + course
            driver.get(url_head + url_tail)
            time.sleep(1)

        #
        # The previous action downloaded spreadsheet(s).
        # The sleep below is to overcome a possible race condition
        # where the browser may be in the midst of copying the
        # downloaded spreadsheet over a slow network file system
        # when the driver attempts to quit.
        #
        time.sleep(15)
        driver.quit()

    download()

# vim:ts=4:sw=4:et
